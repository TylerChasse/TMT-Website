<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      h1 {
        margin-bottom: 10px;
        color: #333;
      }

      .config-section {
        background: #e3f2fd;
        border: 2px solid #90caf9;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }

      .config-section h3 {
        margin-bottom: 10px;
        color: #1976d2;
      }

      .config-section p {
        color: #555;
        line-height: 1.6;
      }

      .config-section code {
        background: #fff;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
        font-size: 13px;
      }

      .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 6px;
        flex-wrap: wrap;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-top: 5px;
      }

      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .media-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: white;
      }

      .media-card.approved {
        border-color: #4caf50;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
      }

      .media-card.denied {
        border-color: #f44336;
        box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);
      }

      .media-preview {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f5f5f5;
        display: block;
      }

      .media-preview.video {
        object-fit: contain;
        background: #000;
      }

      .media-info {
        padding: 15px;
      }

      .media-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 15px;
        line-height: 1.4;
      }

      .media-description {
        font-size: 13px;
        color: #666;
        margin-bottom: 10px;
        line-height: 1.5;
        max-height: 60px;
        overflow: hidden;
      }

      .media-hashtags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
      }

      .hashtag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
      }

      .media-name {
        font-size: 12px;
        color: #999;
        margin-bottom: 5px;
        font-family: "Courier New", monospace;
      }

      .approval-section {
        padding-top: 10px;
        border-top: 1px solid #f0f0f0;
      }

      .status-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .status-button {
        flex: 1;
        padding: 8px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .status-button:hover {
        border-color: #bbb;
      }

      .status-button.active.approved {
        background: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      .status-button.active.pending {
        background: #ff9800;
        color: white;
        border-color: #ff9800;
      }

      .status-button.active.denied {
        background: #f44336;
        color: white;
        border-color: #f44336;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background 0.3s ease;
      }

      .button:hover {
        background: #45a049;
      }

      .button.secondary {
        background: #666;
      }

      .button.secondary:hover {
        background: #555;
      }

      .button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .message {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .message.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .message.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .message.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .debug-panel {
        background: #f9f9f9;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }

      .debug-panel h3 {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Media Approval System</h1>
      <p style="color: #666; margin-bottom: 20px">
        Review and approve media from Airtable
      </p>

      <div id="message"></div>

      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">Total Media</span>
          <span class="stat-value" id="totalCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Approved</span>
          <span class="stat-value" id="approvedCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Pending</span>
          <span class="stat-value" id="pendingCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Denied</span>
          <span class="stat-value" id="deniedCount">0</span>
        </div>
      </div>

      <div class="debug-panel">
        <h3>üêõ Debug Log</h3>
        <div id="debugOutput"></div>
      </div>

      <div id="loading" class="loading">Loading media from Airtable...</div>
      <div id="mediaGrid" class="media-grid"></div>

      <div class="action-buttons">
        <button class="button" onclick="syncToAirtable()">
          üíæ Save to Airtable
        </button>
        <button class="button secondary" onclick="approveAllMedia()">
          ‚úì Approve All
        </button>
        <button class="button secondary" onclick="resetAllToPending()">
          ‚Ü∫ Reset All to Pending
        </button>
      </div>
    </div>

    <script>
      // ============================================
      // CONFIGURATION - UPDATE THESE VALUES
      // ============================================
      const AIRTABLE_CONFIG = {
        token: "patDOZjuXZpa3ZySv.bab6c7187a0bda4c6579c9cfbd11aeb1d6d2f8556efb48300e44b24b9d9641d3",
        baseId: "appXteAFbB6ZwFuow",
        tableName: "Work Order 10/24/2025 16:18:41",
        
        // Field names in your Airtable (adjust if different)
        fields: {
          contentUrl: "content_url", 
          title: "title",
          description: "description",
          hashtags: "hashtags",
          viralScore: "viral_score",
        },

        // Optional: Filter records (leave empty to get all)
        filterFormula: "", // e.g., "AND({status} = 'Pending', {type} = 'Video')"
      };

      // ============================================
      // STATE MANAGEMENT
      // ============================================
      let mediaFiles = [];
      let approvalStates = {}; // { fileId: { status, airtableRecordId } }

      // ============================================
      // INITIALIZATION
      // ============================================
      async function init() {
        console.log("üöÄ Initializing Media Approval System");
        logDebug("System starting...");

        try {
          await loadFromAirtable();
          
          document.getElementById("loading").style.display = "none";
          
          if (mediaFiles.length === 0) {
            showMessage("No media records found in Airtable", "info");
          } else {
            renderMediaGrid();
            updateStats();
            showMessage(`Loaded ${mediaFiles.length} media files`, "success");
          }
        } catch (error) {
          console.error("‚ùå Initialization error:", error);
          document.getElementById("loading").style.display = "none";
          showMessage(`Error: ${error.message}`, "error");
          logDebug(`Init error: ${error.message}`);
        }
      }

      // ============================================
      // LOAD FROM AIRTABLE
      // ============================================
      async function loadFromAirtable() {
        logDebug("Fetching records from Airtable...");

        try {
          let allRecords = [];
          let offset = null;

          // Fetch all records (handle pagination)
          do {
            let url = `https://api.airtable.com/v0/${
              AIRTABLE_CONFIG.baseId
            }/${encodeURIComponent(AIRTABLE_CONFIG.tableName)}?`;

            // Add filter if specified
            if (AIRTABLE_CONFIG.filterFormula) {
              url += `filterByFormula=${encodeURIComponent(
                AIRTABLE_CONFIG.filterFormula
              )}&`;
            }

            // Add offset for pagination
            if (offset) {
              url += `offset=${offset}`;
            }

            const response = await fetch(url, {
              headers: {
                Authorization: `Bearer ${AIRTABLE_CONFIG.token}`,
              },
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(
                `Airtable API error: ${response.status} - ${errorText}`
              );
            }

            const data = await response.json();
            allRecords = allRecords.concat(data.records);
            offset = data.offset;

            logDebug(
              `Fetched ${data.records.length} records (total: ${allRecords.length})`
            );
          } while (offset);

          console.log("üì¶ Raw Airtable records:", allRecords);

          // Transform Airtable records to our format
          mediaFiles = allRecords
            .map((record) => {
              const fields = record.fields;
              const contentUrl = fields[AIRTABLE_CONFIG.fields.contentUrl];

              // Skip records without a content URL
              if (!contentUrl) {
                logDebug(`Skipping record ${record.id} - no content_url`);
                return null;
              }

              // Determine file type from URL
              const url = contentUrl;
              const fileName = url.split("/").pop().split("?")[0];
              const ext = fileName.split(".").pop().toLowerCase();

              let type = "file";
              if (["jpg", "jpeg", "png", "gif", "webp", "svg"].includes(ext)) {
                type = "image";
              } else if (["mp4", "webm", "mov", "avi", "mkv"].includes(ext)) {
                type = "video";
              }

              const fileId = `file_${record.id}`;
              const status = (
                fields[AIRTABLE_CONFIG.fields.status] || "Pending"
              ).toLowerCase();

              // Store approval state
              approvalStates[fileId] = {
                status: status,
                airtableRecordId: record.id,
              };

              return {
                id: fileId,
                airtableRecordId: record.id,
                url: url,
                type: type,
                title: fields[AIRTABLE_CONFIG.fields.title] || fileName,
                description: fields[AIRTABLE_CONFIG.fields.description] || "",
                hashtags: fields[AIRTABLE_CONFIG.fields.hashtags] || "",
              };
            })
            .filter((file) => file !== null);

          logDebug(`Loaded ${mediaFiles.length} valid media files`);
          console.log("üé¨ Processed media files:", mediaFiles);
          console.log("üìä Approval states:", approvalStates);
        } catch (error) {
          console.error("Error loading from Airtable:", error);
          throw error;
        }
      }

      // ============================================
      // RENDER MEDIA GRID
      // ============================================
      function renderMediaGrid() {
        const grid = document.getElementById("mediaGrid");

        if (mediaFiles.length === 0) {
          grid.innerHTML = '<div class="loading">No media found</div>';
          return;
        }

        grid.innerHTML = "";

        mediaFiles.forEach((file) => {
          const card = createMediaCard(file);
          grid.appendChild(card);
        });
      }

      // ============================================
      // CREATE MEDIA CARD
      // ============================================
      function createMediaCard(file) {
        const card = document.createElement("div");
        card.className = "media-card";
        card.id = `card-${file.id}`;

        const status = approvalStates[file.id]?.status || "pending";
        if (status === "approved") {
          card.classList.add("approved");
        } else if (status === "denied") {
          card.classList.add("denied");
        }

        // Media preview
        let mediaHTML = "";
        if (file.type === "video") {
          mediaHTML = `<video src="${file.url}" class="media-preview video" controls></video>`;
        } else if (file.type === "image") {
          mediaHTML = `<img src="${file.url}" class="media-preview" alt="${file.title}" loading="lazy">`;
        } else {
          mediaHTML = `<div class="media-preview" style="display:flex;align-items:center;justify-content:center;color:#999;">
                    <span>üìÑ File</span>
                </div>`;
        }

        // Parse hashtags
        const hashtags = file.hashtags
          ? file.hashtags
              .split(/[,\s]+/)
              .filter((h) => h)
              .map((tag) => {
                const cleanTag = tag.startsWith("#") ? tag : `#${tag}`;
                return `<span class="hashtag">${cleanTag}</span>`;
              })
              .join("")
          : "";

        card.innerHTML = `
                ${mediaHTML}
                <div class="media-info">
                    ${
                      file.title
                        ? `<div class="media-title">${file.title}</div>`
                        : ""
                    }
                    ${
                      file.description
                        ? `<div class="media-description">${file.description}</div>`
                        : ""
                    }
                    ${
                      hashtags
                        ? `<div class="media-hashtags">${hashtags}</div>`
                        : ""
                    }
                    <div class="approval-section">
                        <div class="status-selector">
                            <button class="status-button ${
                              status === "approved" ? "active approved" : ""
                            }" 
                                    data-file-id="${file.id}"
                                    data-status="approved">
                                ‚úì Approve
                            </button>
                            <button class="status-button ${
                              status === "pending" ? "active pending" : ""
                            }" 
                                    data-file-id="${file.id}"
                                    data-status="pending">
                                ‚óã Pending
                            </button>
                            <button class="status-button ${
                              status === "denied" ? "active denied" : ""
                            }" 
                                    data-file-id="${file.id}"
                                    data-status="denied">
                                ‚úï Deny
                            </button>
                        </div>
                    </div>
                </div>
            `;

        // Add event listeners to status buttons
        const statusButtons = card.querySelectorAll(".status-button");
        statusButtons.forEach((btn) => {
          btn.addEventListener("click", function () {
            const fileId = this.dataset.fileId;
            const status = this.dataset.status;
            setStatus(fileId, status);
          });
        });

        return card;
      }

      // ============================================
      // SET STATUS
      // ============================================
      function setStatus(fileId, status) {
        console.log(`üìù Setting status for ${fileId}:`, status);

        if (!approvalStates[fileId]) {
          approvalStates[fileId] = {};
        }

        approvalStates[fileId].status = status;

        // Update UI
        const card = document.getElementById(`card-${fileId}`);
        card.classList.remove("approved", "denied");
        if (status === "approved") {
          card.classList.add("approved");
        } else if (status === "denied") {
          card.classList.add("denied");
        }

        // Update buttons
        const buttons = card.querySelectorAll(".status-button");
        buttons.forEach((btn) => {
          btn.classList.remove("active", "approved", "pending", "denied");
          if (btn.dataset.status === status) {
            btn.classList.add("active", status);
          }
        });

        updateStats();
        logDebug(`Status changed: ${fileId} ‚Üí ${status}`);
      }

      // ============================================
      // SYNC TO AIRTABLE
      // ============================================
      async function syncToAirtable() {
        showMessage("Syncing to Airtable...", "info");
        logDebug("Starting sync to Airtable...");

        try {
          const updates = [];

          // Prepare updates for all records
          for (const [fileId, state] of Object.entries(approvalStates)) {
            if (state.airtableRecordId) {
              updates.push({
                id: state.airtableRecordId,
                fields: {
                  [AIRTABLE_CONFIG.fields.status]:
                    state.status.charAt(0).toUpperCase() +
                    state.status.slice(1),
                },
              });
            }
          }

          if (updates.length === 0) {
            showMessage("No records to update", "info");
            return;
          }

          // Batch updates (max 10 per request)
          const batchSize = 10;
          let successCount = 0;

          for (let i = 0; i < updates.length; i += batchSize) {
            const batch = updates.slice(i, i + batchSize);

            const url = `https://api.airtable.com/v0/${
              AIRTABLE_CONFIG.baseId
            }/${encodeURIComponent(AIRTABLE_CONFIG.tableName)}`;
            
            const response = await fetch(url, {
              method: "PATCH",
              headers: {
                Authorization: `Bearer ${AIRTABLE_CONFIG.token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ records: batch }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Airtable API error: ${response.status} - ${errorText}`);
            }

            successCount += batch.length;
            logDebug(
              `Synced batch ${Math.floor(i / batchSize) + 1} (${
                batch.length
              } records)`
            );
          }

          showMessage(
            `‚úì Successfully synced ${successCount} records to Airtable!`,
            "success"
          );
          logDebug(`Sync complete: ${successCount} records updated`);
        } catch (error) {
          console.error("Error syncing to Airtable:", error);
          showMessage(`Error: ${error.message}`, "error");
          logDebug(`Sync error: ${error.message}`);
        }
      }

      // ============================================
      // BATCH ACTIONS
      // ============================================
      function resetAllToPending() {
        mediaFiles.forEach((file) => {
          setStatus(file.id, "pending");
        });
        showMessage("All media reset to pending", "info");
      }

      function approveAllMedia() {
        mediaFiles.forEach((file) => {
          setStatus(file.id, "approved");
        });
        showMessage("All media approved!", "success");
      }

      // ============================================
      // UPDATE STATS
      // ============================================
      function updateStats() {
        const totalCount = mediaFiles.length;
        let approvedCount = 0;
        let pendingCount = 0;
        let deniedCount = 0;

        Object.values(approvalStates).forEach((state) => {
          if (state.status === "approved") approvedCount++;
          else if (state.status === "denied") deniedCount++;
          else pendingCount++;
        });

        document.getElementById("totalCount").textContent = totalCount;
        document.getElementById("approvedCount").textContent = approvedCount;
        document.getElementById("pendingCount").textContent = pendingCount;
        document.getElementById("deniedCount").textContent = deniedCount;
      }

      // ============================================
      // UI HELPERS
      // ============================================
      function showMessage(text, type = "info") {
        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
        setTimeout(() => {
          messageDiv.innerHTML = "";
        }, 5000);
      }

      function logDebug(message) {
        const debugOutput = document.getElementById("debugOutput");
        const timestamp = new Date().toLocaleTimeString();
        debugOutput.innerHTML =
          `[${timestamp}] ${message}<br>` + debugOutput.innerHTML;

        // Keep only last 20 messages
        const lines = debugOutput.innerHTML.split("<br>");
        if (lines.length > 20) {
          debugOutput.innerHTML = lines.slice(0, 20).join("<br>");
        }
      }

      // ============================================
      // START
      // ============================================
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    </script>
  </body>
</html>