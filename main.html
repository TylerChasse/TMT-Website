<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Media Approval System - Integrated</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      h1 {
        margin-bottom: 10px;
        color: #333;
      }

      .config-section {
        background: #e3f2fd;
        border: 2px solid #90caf9;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }

      .config-section h3 {
        margin-bottom: 10px;
        color: #1976d2;
      }

      .config-section p {
        color: #555;
        line-height: 1.6;
      }

      .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 6px;
        flex-wrap: wrap;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-top: 5px;
      }

      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .media-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: white;
      }

      .media-card.approved {
        border-color: #4caf50;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
      }

      .media-card.denied {
        border-color: #f44336;
        box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);
      }

      .media-preview {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f5f5f5;
        display: block;
      }

      .media-preview.video {
        object-fit: contain;
        background: #000;
      }

      .media-info {
        padding: 15px;
      }

      .media-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 15px;
        line-height: 1.4;
      }

      .media-description {
        font-size: 13px;
        color: #666;
        margin-bottom: 10px;
        line-height: 1.5;
        max-height: 60px;
        overflow: hidden;
      }

      .media-hashtags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
      }

      .hashtag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
      }

      .media-name {
        font-size: 12px;
        color: #999;
        margin-bottom: 5px;
        font-family: "Courier New", monospace;
      }

      .approval-section {
        padding-top: 10px;
        border-top: 1px solid #f0f0f0;
      }

      .status-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .status-button {
        flex: 1;
        padding: 8px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .status-button:hover {
        border-color: #bbb;
      }

      .status-button.active.approved {
        background: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      .status-button.active.pending {
        background: #ff9800;
        color: white;
        border-color: #ff9800;
      }

      .status-button.active.denied {
        background: #f44336;
        color: white;
        border-color: #f44336;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background 0.3s ease;
      }

      .button:hover {
        background: #45a049;
      }

      .button.secondary {
        background: #666;
      }

      .button.secondary:hover {
        background: #555;
      }

      .button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .message {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .message.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .message.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .message.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .debug-panel {
        background: #f9f9f9;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        font-family: "Courier New", monospace;
        font-size: 13px;
      }

      .debug-panel h3 {
        margin-bottom: 15px;
        color: #333;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Media Approval System</h1>
      <p style="color: #666; margin-bottom: 20px">
        Videos from Cloudflare, metadata from Airtable
      </p>

      <div class="config-section">
        <h3>üì° Data Sources</h3>
        <p><strong>Videos:</strong> Loaded from Cloudflare R2 Storage</p>
        <p>
          <strong>Metadata:</strong> Synced with Airtable (Title, Description,
          Hashtags, Status)
        </p>
      </div>

      <div id="message"></div>

      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">Total Media</span>
          <span class="stat-value" id="totalCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Approved</span>
          <span class="stat-value" id="approvedCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Pending</span>
          <span class="stat-value" id="pendingCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Denied</span>
          <span class="stat-value" id="deniedCount">0</span>
        </div>
      </div>

      <div id="mediaGrid" class="media-grid">
        <div class="loading">Loading media...</div>
      </div>

      <div class="action-buttons">
        <button id="syncButton" class="button">
          Sync All Changes to Airtable
        </button>
        <button id="approveAllButton" class="button secondary">
          Approve All
        </button>
        <button id="clearButton" class="button secondary">
          Reset All to Pending
        </button>
      </div>

      <div class="debug-panel">
        <h3>üêõ Debug Console</h3>
        <div id="debugOutput" style="color: #666">Ready to load data...</div>
      </div>
    </div>

    <script>
      // CONFIGURATION
      const CLOUDFLARE_CONFIG = {
        workerUrl: "https://get-media-in-folder.tyler-chasse.workers.dev",
        folderPath: "October_2025/Work_Order_10_19_2025_16:59:35/",
      };

      const AIRTABLE_CONFIG = {
        token: "patDOZjuXZpa3ZySv.bab6c7187a0bda4c6579c9cfbd11aeb1d6d2f8556efb48300e44b24b9d9641d3",
        baseId: "appXteAFbB6ZwFuow",
        tableName: "Work Order 10/19/2025 16:59:35",
      };

      // STATE
      let cloudflareFiles = []; // Raw video files from Cloudflare
      let airtableData = {}; // Metadata from Airtable, keyed by video_id
      let mediaFiles = []; // Combined data
      let approvalStates = {}; // Status for each video

      // INITIALIZE
      function init() {
        console.log("üöÄ Initializing Media Approval System");
        console.log("üì° Cloudflare Worker:", CLOUDFLARE_CONFIG.workerUrl);
        console.log("üìä Airtable Base:", AIRTABLE_CONFIG.baseId);

        // Load data from both sources
        loadAllData();

        // Setup button listeners
        document
          .getElementById("syncButton")
          .addEventListener("click", syncToAirtable);
        document
          .getElementById("clearButton")
          .addEventListener("click", resetAllToPending);
        document
          .getElementById("approveAllButton")
          .addEventListener("click", approveAllMedia);
      }

      // LOAD DATA FROM BOTH SOURCES
      async function loadAllData() {
        try {
          showMessage("Loading data...", "info");
          logDebug("Starting data load from Cloudflare and Airtable");

          // Load in parallel
          const [cfResult, atResult] = await Promise.allSettled([
            loadFromCloudflare(),
            loadFromAirtable(),
          ]);

          if (cfResult.status === "rejected") {
            throw new Error(`Cloudflare: ${cfResult.reason}`);
          }
          if (atResult.status === "rejected") {
            throw new Error(`Airtable: ${atResult.reason}`);
          }

          // Merge the data
          mergeData();

          renderMediaGrid();
          updateStats();

          showMessage(
            `‚úì Loaded ${mediaFiles.length} videos successfully!`,
            "success"
          );
          logDebug(`Data merge complete: ${mediaFiles.length} videos ready`);
        } catch (error) {
          console.error("‚ùå Error loading data:", error);
          showMessage(`Error: ${error.message}`, "error");
          logDebug(`Load error: ${error.message}`);
        }
      }

      // LOAD FROM CLOUDFLARE
      async function loadFromCloudflare() {
        logDebug("Loading videos from Cloudflare...");

        const url = `${CLOUDFLARE_CONFIG.workerUrl}/list?prefix=${CLOUDFLARE_CONFIG.folderPath}`;
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`Cloudflare HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        cloudflareFiles = data.files || [];
        logDebug(`Loaded ${cloudflareFiles.length} files from Cloudflare`);
        console.log("üì¶ Cloudflare files:", cloudflareFiles);

        return cloudflareFiles;
      }

      // LOAD FROM AIRTABLE
      async function loadFromAirtable() {
        logDebug("Loading metadata from Airtable...");

        const url = `https://api.airtable.com/v0/${
          AIRTABLE_CONFIG.baseId
        }/${encodeURIComponent(AIRTABLE_CONFIG.tableName)}`;
        const response = await fetch(url, {
          headers: {
            Authorization: `Bearer ${AIRTABLE_CONFIG.token}`,
          },
        });

        if (!response.ok) {
          throw new Error(`Airtable HTTP ${response.status}`);
        }

        const data = await response.json();

        // Convert to lookup object keyed by video_id
        airtableData = {};
        data.records.forEach((record) => {
          const fields = record.fields;
          const videoId = fields.id;
          
          if (videoId != null) {
            airtableData[videoId] = {
              recordId: record.id,
              title: fields.title || "",
              description:
                fields.description?.value || fields.description || "",
              hashtags:
                fields.relevant_hashtags?.value ||
                fields.relevant_hashtags ||
                "",
              status: fields.status || "Pending",
            };
          }
        });

        logDebug(
          `Loaded ${Object.keys(airtableData).length} records from Airtable`
        );
        console.log("üìä Airtable data:", airtableData);

        return airtableData;
      }

      // MERGE CLOUDFLARE + AIRTABLE DATA
      function mergeData() {
        logDebug("Merging Cloudflare and Airtable data...");

        mediaFiles = cloudflareFiles.map((file) => {
          // Use file.id or file.name as the lookup key
          const lookupKey = file.name.substring(0, file.name.lastIndexOf("."));
          const metadata = airtableData[lookupKey] || {};
          console.log("Lookup Key:", lookupKey, "Metadata:", metadata);
          // Determine content type
          const isVideo =
            file.contentType?.startsWith("video/") ||
            file.url?.includes(".mp4") ||
            file.name?.endsWith(".mp4");

          const merged = {
            // From Cloudflare
            id: file.id,
            name: file.name,
            url: file.url,
            size: file.size,
            uploaded: file.uploaded,
            contentType: file.contentType,
            type: isVideo ? "video" : "image",

            // From Airtable
            airtableRecordId: metadata.recordId || null,
            title: metadata.title || file.name,
            description: metadata.description || "",
            hashtags: metadata.hashtags || "",
            status: metadata.status || "Pending",
          };

          // Initialize approval state
          approvalStates[file.id] = {
            status: (metadata.status || "Pending").toLowerCase(),
            airtableRecordId: metadata.recordId,
          };

          return merged;
        });

        logDebug(`Merged ${mediaFiles.length} files with metadata`);
        console.log("üé¨ Merged media files:", mediaFiles);
      }

      // RENDER MEDIA GRID
      function renderMediaGrid() {
        const grid = document.getElementById("mediaGrid");

        if (mediaFiles.length === 0) {
          grid.innerHTML = '<div class="loading">No media found</div>';
          return;
        }

        grid.innerHTML = "";

        mediaFiles.forEach((file) => {
          const card = createMediaCard(file);
          grid.appendChild(card);
        });
      }

      // CREATE MEDIA CARD
      function createMediaCard(file) {
        const card = document.createElement("div");
        card.className = "media-card";
        card.id = `card-${file.id}`;

        const status = approvalStates[file.id]?.status || "pending";
        if (status === "approved") {
          card.classList.add("approved");
        } else if (status === "denied") {
          card.classList.add("denied");
        }

        // Media preview
        let mediaHTML = "";
        if (file.type === "video") {
          mediaHTML = `<video src="${file.url}" class="media-preview video" controls></video>`;
        } else if (file.type === "image") {
          mediaHTML = `<img src="${file.url}" class="media-preview" alt="${file.title}" loading="lazy">`;
        } else {
          mediaHTML = `<div class="media-preview" style="display:flex;align-items:center;justify-content:center;color:#999;">
                    <span>üìÑ File</span>
                </div>`;
        }

        // Parse hashtags
        const hashtags = file.hashtags
          ? file.hashtags
              .split(/[,\s]+/)
              .filter((h) => h)
              .map((tag) => {
                const cleanTag = tag.startsWith("#") ? tag : `#${tag}`;
                return `<span class="hashtag">${cleanTag}</span>`;
              })
              .join("")
          : "";

        card.innerHTML = `
                ${mediaHTML}
                <div class="media-info">
                    ${
                      file.title
                        ? `<div class="media-title">${file.title}</div>`
                        : ""
                    }
                    ${
                      file.description
                        ? `<div class="media-description">${file.description}</div>`
                        : ""
                    }
                    ${
                      hashtags
                        ? `<div class="media-hashtags">${hashtags}</div>`
                        : ""
                    }
                    <div class="approval-section">
                        <div class="status-selector">
                            <button class="status-button ${
                              status === "approved" ? "active approved" : ""
                            }" 
                                    onclick="setStatus('${
                                      file.id
                                    }', 'approved')">
                                ‚úì Approve
                            </button>
                            <button class="status-button ${
                              status === "pending" ? "active pending" : ""
                            }" 
                                    onclick="setStatus('${
                                      file.id
                                    }', 'pending')">
                                ‚óã Pending
                            </button>
                            <button class="status-button ${
                              status === "denied" ? "active denied" : ""
                            }" 
                                    onclick="setStatus('${file.id}', 'denied')">
                                ‚úï Deny
                            </button>
                        </div>
                    </div>
                </div>
            `;

        return card;
      }

      // SET STATUS
      window.setStatus = function (fileId, status) {
        console.log(`üìù Setting status for ${fileId}:`, status);

        if (!approvalStates[fileId]) {
          approvalStates[fileId] = {};
        }

        approvalStates[fileId].status = status;

        // Update UI
        const card = document.getElementById(`card-${fileId}`);
        card.classList.remove("approved", "denied");
        if (status === "approved") {
          card.classList.add("approved");
        } else if (status === "denied") {
          card.classList.add("denied");
        }

        // Update buttons
        const buttons = card.querySelectorAll(".status-button");
        buttons.forEach((btn) => {
          btn.classList.remove("active", "approved", "pending", "denied");
          if (btn.textContent.includes("Approve") && status === "approved") {
            btn.classList.add("active", "approved");
          } else if (
            btn.textContent.includes("Pending") &&
            status === "pending"
          ) {
            btn.classList.add("active", "pending");
          } else if (btn.textContent.includes("Deny") && status === "denied") {
            btn.classList.add("active", "denied");
          }
        });

        updateStats();
        logDebug(`Status changed: ${fileId} ‚Üí ${status}`);
      };

      // SYNC TO AIRTABLE
      async function syncToAirtable() {
        showMessage("Syncing to Airtable...", "info");
        logDebug("Starting sync to Airtable...");

        try {
          const updates = [];

          // Only update records that have an Airtable record ID
          for (const [fileId, state] of Object.entries(approvalStates)) {
            if (state.airtableRecordId) {
              updates.push({
                id: state.airtableRecordId,
                fields: {
                  status:
                    state.status.charAt(0).toUpperCase() +
                    state.status.slice(1),
                },
              });
            }
          }

          if (updates.length === 0) {
            showMessage("No Airtable records to update", "info");
            return;
          }

          // Batch updates (max 10 per request)
          const batchSize = 10;
          for (let i = 0; i < updates.length; i += batchSize) {
            const batch = updates.slice(i, i + batchSize);

            const url = `https://api.airtable.com/v0/${
              AIRTABLE_CONFIG.baseId
            }/${encodeURIComponent(AIRTABLE_CONFIG.tableName)}`;
            const response = await fetch(url, {
              method: "PATCH",
              headers: {
                Authorization: `Bearer ${AIRTABLE_CONFIG.token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ records: batch }),
            });

            if (!response.ok) {
              throw new Error(`Airtable API error: ${response.status}`);
            }

            logDebug(
              `Synced batch ${Math.floor(i / batchSize) + 1} (${
                batch.length
              } records)`
            );
          }

          showMessage(
            `‚úì Successfully synced ${updates.length} records to Airtable!`,
            "success"
          );
          logDebug(`Sync complete: ${updates.length} records updated`);
        } catch (error) {
          console.error("Error syncing to Airtable:", error);
          showMessage(`Error: ${error.message}`, "error");
          logDebug(`Sync error: ${error.message}`);
        }
      }

      // RESET ALL TO PENDING
      function resetAllToPending() {
        mediaFiles.forEach((file) => {
          setStatus(file.id, "pending");
        });
        showMessage("All media reset to pending", "info");
      }

      // APPROVE ALL
      function approveAllMedia() {
        mediaFiles.forEach((file) => {
          setStatus(file.id, "approved");
        });
        showMessage("All media approved!", "success");
      }

      // UPDATE STATS
      function updateStats() {
        const totalCount = mediaFiles.length;
        let approvedCount = 0;
        let pendingCount = 0;
        let deniedCount = 0;

        Object.values(approvalStates).forEach((state) => {
          if (state.status === "approved") approvedCount++;
          else if (state.status === "denied") deniedCount++;
          else pendingCount++;
        });

        document.getElementById("totalCount").textContent = totalCount;
        document.getElementById("approvedCount").textContent = approvedCount;
        document.getElementById("pendingCount").textContent = pendingCount;
        document.getElementById("deniedCount").textContent = deniedCount;
      }

      // SHOW MESSAGE
      function showMessage(text, type = "info") {
        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
        setTimeout(() => {
          messageDiv.innerHTML = "";
        }, 5000);
      }

      // LOG DEBUG
      function logDebug(message) {
        const debugOutput = document.getElementById("debugOutput");
        const timestamp = new Date().toLocaleTimeString();
        debugOutput.innerHTML =
          `[${timestamp}] ${message}<br>` + debugOutput.innerHTML;

        // Keep only last 20 messages
        const lines = debugOutput.innerHTML.split("<br>");
        if (lines.length > 20) {
          debugOutput.innerHTML = lines.slice(0, 20).join("<br>");
        }
      }

      // START
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    </script>
  </body>
</html>
