<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Approval System - Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .debug-panel {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .debug-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .debug-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #ccc;
        }
        
        .debug-item.approved {
            border-left-color: #4caf50;
            background: #f1f8f4;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-top: 5px;
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .media-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            background: white;
        }
        
        .media-card.approved {
            border-color: #4caf50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }
        
        .media-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f5f5f5;
            display: block;
        }
        
        .media-preview.video {
            object-fit: contain;
            background: #000;
        }
        
        .media-info {
            padding: 15px;
        }
        
        .media-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            word-break: break-word;
            font-size: 14px;
        }
        
        .media-id {
            font-size: 11px;
            color: #999;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
        }
        
        .approval-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #4caf50;
        }
        
        .checkbox-wrapper label {
            cursor: pointer;
            color: #666;
            font-size: 14px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease;
        }
        
        .button:hover {
            background: #45a049;
        }
        
        .button.secondary {
            background: #666;
        }
        
        .button.secondary:hover {
            background: #555;
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 6px;
            color: #155724;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Media Approval System - Demo Mode</h1>
        <p style="color: #666; margin-bottom: 20px;">Testing with placeholder media - checkboxes update the approval state in real-time</p>
        
        <div id="message"></div>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Total Media</span>
                <span class="stat-value" id="totalCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Approved</span>
                <span class="stat-value" id="approvedCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Pending</span>
                <span class="stat-value" id="pendingCount">0</span>
            </div>
        </div>
        
        <div class="debug-panel">
            <h3>üêõ Debug Panel - Current Approval State</h3>
            <div id="debugOutput"></div>
        </div>
        
        <div id="mediaGrid" class="media-grid"></div>
        
        <div class="action-buttons">
            <button id="saveButton" class="button">Save Approvals (Console Log)</button>
            <button id="clearButton" class="button secondary">Clear All Approvals</button>
            <button id="approveAllButton" class="button secondary">Approve All</button>
        </div>
    </div>

    <script>
(function() {
    'use strict';
    
    // Configuration
    const CLOUDFLARE_CONFIG = {
        workerUrl: 'https://get-media-in-folder.tyler-chasse.workers.dev',
        folderPath: 'oct-2025/1/'
    };

    let mediaFiles = [];
    let approvals = {};

    // Load media files dynamically from Cloudflare
    async function loadMediaFromCloudflare() {
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) loadingDiv.style.display = 'block';
        
        try {
            console.log('üì° Fetching media from:', `${CLOUDFLARE_CONFIG.workerUrl}/list?prefix=${CLOUDFLARE_CONFIG.folderPath}`);
            
            const response = await fetch(
                `${CLOUDFLARE_CONFIG.workerUrl}/list?prefix=${CLOUDFLARE_CONFIG.folderPath}`
            );
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            mediaFiles = data.files || [];
            
            console.log('‚úÖ Successfully loaded media files:', mediaFiles);
            console.log('üìä Total files:', data.count);
            
            if (loadingDiv) loadingDiv.style.display = 'none';
            
            if (mediaFiles.length === 0) {
                showError(`No files found in folder: ${CLOUDFLARE_CONFIG.folderPath}`);
                return;
            }
            
            renderMediaGrid();
          
          	// Inside loadMediaFromCloudflare(), after renderMediaGrid()
console.log('üîç DEBUG: First 3 file objects:', mediaFiles.slice(0, 3));
console.log('üîç DEBUG: First file URL:', mediaFiles[0]?.url);

// Try loading first image directly
if (mediaFiles[0]) {
    const testImg = new Image();
    testImg.onload = () => console.log('‚úÖ First image loaded successfully');
    testImg.onerror = (e) => console.error('‚ùå First image failed to load:', e);
    testImg.src = mediaFiles[0].url;
}
          
            updateStats();
            updateDebugPanel();
            
            // Show action buttons
            const saveButton = document.getElementById('saveButton');
            if (saveButton) saveButton.style.display = 'block';
            
        } catch (error) {
            console.error('‚ùå Error loading media:', error);
            if (loadingDiv) loadingDiv.style.display = 'none';
            showError('Failed to load media: ' + error.message);
        }
    }

    // Render media grid
    function renderMediaGrid() {
        const grid = document.getElementById('mediaGrid');
        if (!grid) return;
        
        grid.innerHTML = '';

        mediaFiles.forEach(file => {
            const card = createMediaCard(file);
            grid.appendChild(card);
        });
    }

    // Create individual media card
    function createMediaCard(file) {
        const card = document.createElement('div');
        card.className = 'media-card';
        card.id = `card-${file.id}`;
        card.dataset.fileId = file.id;
        
        if (approvals[file.id]) {
            card.classList.add('approved');
        }

        const isVideo = file.type === 'video' || file.contentType?.startsWith('video/');
        const isImage = file.type === 'image' || file.contentType?.startsWith('image/');

        let mediaHTML = '';
        if (isImage) {
            mediaHTML = `<img src="${file.url}" class="media-preview" alt="${file.name}" loading="lazy">`;
        } else if (isVideo) {
            mediaHTML = `<video src="${file.url}" class="media-preview video" controls></video>`;
        } else {
            mediaHTML = `<div class="media-preview" style="display:flex;align-items:center;justify-content:center;color:#999;">
                <span>üìÑ ${file.name?.split('.').pop()?.toUpperCase() || 'File'}</span>
            </div>`;
        }

        const isApproved = approvals[file.id] === true;

        card.innerHTML = `
            ${mediaHTML}
            <div class="media-info">
                <div class="media-name">${file.name}</div>
                <div class="media-id">ID: ${file.id}</div>
                <div class="approval-section">
                    <div class="checkbox-wrapper">
                        <input 
                            type="checkbox" 
                            id="approve-${file.id}"
                            data-file-id="${file.id}"
                            ${isApproved ? 'checked' : ''}
                        >
                        <label for="approve-${file.id}">Approved</label>
                    </div>
                    <span class="status-badge ${isApproved ? 'approved' : 'pending'}">
                        ${isApproved ? '‚úì Approved' : 'Pending'}
                    </span>
                </div>
            </div>
        `;

        // Add event listener directly to the checkbox (NO inline handlers)
        const checkbox = card.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function(e) {
            toggleApproval(file.id, e.target.checked);
        });

        return card;
    }

    // Toggle approval status
    function toggleApproval(fileId, isApproved) {
        console.log(`üìù Toggling approval for ${fileId}:`, isApproved);
        
        if (isApproved) {
            approvals[fileId] = true;
        } else {
            delete approvals[fileId];
        }
        
        updateCardStyle(fileId, isApproved);
        updateStats();
        updateDebugPanel();
        
        console.log('üìä Current approvals state:', approvals);
    }

    // Update card styling
    function updateCardStyle(fileId, isApproved) {
        const card = document.getElementById(`card-${fileId}`);
        if (!card) return;
        
        const statusBadge = card.querySelector('.status-badge');
        
        if (isApproved) {
            card.classList.add('approved');
            statusBadge.classList.remove('pending');
            statusBadge.classList.add('approved');
            statusBadge.textContent = '‚úì Approved';
        } else {
            card.classList.remove('approved');
            statusBadge.classList.remove('approved');
            statusBadge.classList.add('pending');
            statusBadge.textContent = 'Pending';
        }
    }

    // Update statistics
    function updateStats() {
        const totalCount = mediaFiles.length;
        const approvedCount = Object.keys(approvals).length;
        const pendingCount = totalCount - approvedCount;
        
        const totalEl = document.getElementById('totalCount');
        const approvedEl = document.getElementById('approvedCount');
        const pendingEl = document.getElementById('pendingCount');
        
        if (totalEl) totalEl.textContent = totalCount;
        if (approvedEl) approvedEl.textContent = approvedCount;
        if (pendingEl) pendingEl.textContent = pendingCount;
    }

    // Update debug panel
    function updateDebugPanel() {
        const debugOutput = document.getElementById('debugOutput');
        if (!debugOutput) return;
        
        if (Object.keys(approvals).length === 0) {
            debugOutput.innerHTML = '<div style="color: #999; padding: 10px;">No approvals yet...</div>';
            return;
        }
        
        let html = '';
        mediaFiles.forEach(file => {
            const isApproved = approvals[file.id] === true;
            const className = isApproved ? 'approved' : '';
            const status = isApproved ? '‚úì APPROVED' : '‚óã PENDING';
            
            html += `
                <div class="debug-item ${className}">
                    <strong>${file.name}</strong><br>
                    ID: ${file.id}<br>
                    Status: ${status}<br>
                    Value: approvals['${file.id}'] = ${approvals[file.id] || 'undefined'}
                </div>
            `;
        });
        
        debugOutput.innerHTML = html;
    }

    // Save approvals
    function saveApprovals() {
        console.log('üíæ SAVE CLICKED - Current approval data:');
        console.log(JSON.stringify(approvals, null, 2));
        
        const dataToSave = {
            contactId: 'CONTACT_ID_HERE',
            customFieldKey: 'approved_media',
            customFieldValue: JSON.stringify(approvals),
            timestamp: new Date().toISOString(),
            approvedCount: Object.keys(approvals).length,
            approvedMediaIds: Object.keys(approvals)
        };
        
        console.log('üì§ Data that would be sent to API:');
        console.log(JSON.stringify(dataToSave, null, 2));
        
        showSuccess(`‚úì Approvals logged to console! ${Object.keys(approvals).length} items approved.`);
    }

    // Clear all approvals
    function clearAllApprovals() {
        console.log('üßπ Clearing all approvals');
        approvals = {};
        
        mediaFiles.forEach(file => {
            const checkbox = document.getElementById(`approve-${file.id}`);
            if (checkbox) {
                checkbox.checked = false;
                updateCardStyle(file.id, false);
            }
        });
        
        updateStats();
        updateDebugPanel();
        
        showSuccess('All approvals cleared!');
    }

    // Approve all media
    function approveAllMedia() {
        console.log('‚úÖ Approving all media');
        
        mediaFiles.forEach(file => {
            approvals[file.id] = true;
            const checkbox = document.getElementById(`approve-${file.id}`);
            if (checkbox) {
                checkbox.checked = true;
                updateCardStyle(file.id, true);
            }
        });
        
        updateStats();
        updateDebugPanel();
        
        showSuccess('All media approved!');
    }

    // Show error message
    function showError(message) {
        const messageDiv = document.getElementById('message');
        if (!messageDiv) return;
        messageDiv.innerHTML = `<div class="error">${message}</div>`;
    }

    // Show success message
    function showSuccess(message) {
        const messageDiv = document.getElementById('message');
        if (!messageDiv) return;
        messageDiv.innerHTML = `<div class="success-message">${message}</div>`;
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 3000);
    }

    // Initialize when DOM is ready
    function init() {
        console.log('üöÄ Initializing Media Approval System');
        
        loadMediaFromCloudflare();
        
        // Setup button event listeners
        const saveButton = document.getElementById('saveButton');
        const clearButton = document.getElementById('clearButton');
        const approveAllButton = document.getElementById('approveAllButton');
        
        if (saveButton) {
            saveButton.addEventListener('click', saveApprovals);
        }
        if (clearButton) {
            clearButton.addEventListener('click', clearAllApprovals);
        }
        if (approveAllButton) {
            approveAllButton.addEventListener('click', approveAllMedia);
        }
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
