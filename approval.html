<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Approval Page</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      h1 {
        margin-bottom: 10px;
        color: #333;
      }

      .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 6px;
        flex-wrap: wrap;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-top: 5px;
      }

      .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .content-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: white;
      }

      .content-card.approved {
        border-color: #4caf50;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
      }

      .content-card.denied {
        border-color: #f44336;
        box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);
      }

      .content-preview {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f5f5f5;
        display: block;
      }

      .content-preview.video {
        object-fit: contain;
        background: #000;
      }

      .content-info {
        padding: 15px;
      }

      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .content-title {
        font-weight: 600;
        color: #333;
        font-size: 15px;
        line-height: 1.4;
        flex: 1;
      }

      .viral-score-badge {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        cursor: help;
        position: relative;
        flex-shrink: 0;
        margin-left: 8px;
      }

      .viral-score-badge.high {
        background: #4caf50;
        color: white;
      }

      .viral-score-badge.medium {
        background: #ff9800;
        color: white;
      }

      .viral-score-badge.low {
        background: #9e9e9e;
        color: white;
      }

      .viral-score-badge:hover::after {
        content: attr(data-reason);
        position: absolute;
        bottom: 100%;
        right: 0;
        margin-bottom: 8px;
        padding: 10px;
        background: #333;
        color: white;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 400;
        white-space: normal;
        width: 250px;
        text-align: left;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        line-height: 1.4;
      }

      .viral-score-badge:hover::before {
        content: '';
        position: absolute;
        bottom: 100%;
        right: 20px;
        margin-bottom: 2px;
        border: 6px solid transparent;
        border-top-color: #333;
        z-index: 1001;
      }

      .content-description {
        font-size: 13px;
        color: #666;
        margin-bottom: 10px;
        line-height: 1.5;
        max-height: 60px;
        overflow: hidden;
      }

      .content-hashtags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
      }

      .hashtag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
      }

      .content-name {
        font-size: 12px;
        color: #999;
        margin-bottom: 5px;
        font-family: "Courier New", monospace;
      }

      .approval-section {
        padding-top: 10px;
        border-top: 1px solid #f0f0f0;
      }

      .status-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .status-button {
        flex: 1;
        padding: 8px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .status-button:hover {
        border-color: #bbb;
      }

      .status-button.active.approved {
        background: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      .status-button.active.pending {
        background: #ff9800;
        color: white;
        border-color: #ff9800;
      }

      .status-button.active.denied {
        background: #f44336;
        color: white;
        border-color: #f44336;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background 0.3s ease;
      }

      .button:hover {
        background: #45a049;
      }

      .button.secondary {
        background: #666;
      }

      .button.secondary:hover {
        background: #555;
      }

      .button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .content-grid {
          grid-template-columns: 1fr;
        }

        .content-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .viral-score-badge {
          margin-left: 0;
          margin-top: 8px;
        }

        .viral-score-badge:hover::after {
          right: auto;
          left: 0;
        }

        .viral-score-badge:hover::before {
          right: auto;
          left: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Content Approval System</h1>
      <p style="color: #666; margin-bottom: 20px">
        Review and approve content
      </p>

      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">Total content</span>
          <span class="stat-value" id="totalCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Approved</span>
          <span class="stat-value" id="approvedCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Pending</span>
          <span class="stat-value" id="pendingCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Denied</span>
          <span class="stat-value" id="deniedCount">0</span>
        </div>
      </div>

      <div id="loading" class="loading">Loading content from Airtable...</div>
      <div id="contentGrid" class="content-grid"></div>

      <div id="actionButtons" class="action-buttons">
        <button class="button secondary" onclick="approveAllcontent()">
          ‚úì Approve All
        </button>
        <button class="button" id="submitButton" onclick="syncToAirtable()">
          üì§ Submit Approvals
        </button>
      </div>
    </div>

    <script>
      // ============================================
      // CONFIGURATION - UPDATE THESE VALUES
      // ============================================
      const CONFIG = {
        token: "patDOZjuXZpa3ZySv.49fa36d882b45f51832e870a66e47c8d26771e340488fd966a59dc369a052cea", // Your Personal Access Token
        baseId: "", 
        tableName: "",
        email: localStorage.getItem('email'),
        ghlLocationId: localStorage.getItem('ghlLocationId'),
        
        // Field names in your Airtable (adjust if different)
        fields: {
          contentUrl: "content_url", // Required: URL to content file
          status: "status", // Required: approval status (single select field)
          title: "title", // Optional
          description: "description", // Optional
          hashtags: "hashtags", // Optional
          viralScore: "viral_score", // Optional
          viralReason: "viral_reason", // Optional
          socialcontentPlatforms: "social_content_platforms", // Optional
        },

        // Work Orders table configuration
        workOrdersTable: {
          tableName: "Work Orders", // Name of the Work Orders table
          nameField: "name", // Field that contains "Work Order date time"
          approvedCheckboxField: "approved", // Checkbox field to update
        },

        // n8n webhook configuration
        n8nWebhook: {
          enabled: true, // Set to false to disable n8n integration
          url: "https://talentedmarketingtalents.app.n8n.cloud/webhook-test/intake/approvals",
        },

        // Optional: Filter records (leave empty to get all)
        filterFormula: "", // e.g., "AND({status} = 'Pending', {type} = 'Video')"
      };

      // ============================================
      // LOAD URL PARAMETERS
      // ============================================
      function loadURLParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        const baseIdParam = urlParams.get('baseId') || urlParams.get('base_id');
        const tableNameParam = urlParams.get('tableName') || urlParams.get('table_name');
        
        if (baseIdParam) {
          CONFIG.baseId = baseIdParam;
        }
        
        if (tableNameParam) {
          CONFIG.tableName = decodeURIComponent(tableNameParam);
        }

        return !!(baseIdParam && tableNameParam);
      }

      // ============================================
      // STATE MANAGEMENT
      // ============================================
      let contentFiles = [];
      let approvalStates = {}; // { fileId: { status, airtableRecordId } }
      let workOrderRecordId = null; // Store the Work Order record ID
      let isWorkOrderApproved = false; // Track if work order is already approved
      let isReadOnlyMode = false; // Track if we're in read-only mode

      // ============================================
      // INITIALIZATION
      // ============================================
      async function init() {
        try {
          // Load parameters from URL
          loadURLParameters();
          
          if (!CONFIG.baseId) {
            alert("‚ö†Ô∏è Missing Airtable Base ID. Please provide baseId in URL.");
            document.getElementById("loading").style.display = "none";
            return;
          }

          if (!CONFIG.tableName) {
            alert("‚ö†Ô∏è Missing Table Name. Please provide tableName in URL.");
            document.getElementById("loading").style.display = "none";
            return;
          }

          await loadFromAirtable();
          
          document.getElementById("loading").style.display = "none";
          
          if (contentFiles.length === 0) {
            document.getElementById("contentGrid").innerHTML = '<div class="loading">No content records found</div>';
          } else {
            rendercontentGrid();
            updateStats();
          }

          // Show/hide UI elements based on read-only mode
          if (isReadOnlyMode) {
            
            // Hide action buttons
            document.getElementById("actionButtons").style.display = "none";
            
            // Update page title
            document.querySelector("h1").textContent = "Content Viewer";
            document.querySelector("h1").nextElementSibling.textContent = "View approved content and their status";
          }
        } catch (error) {
          document.getElementById("loading").style.display = "none";
          alert(`Error loading content: ${error.message}`);
        }
      }

      // ============================================
      // LOAD FROM AIRTABLE
      // ============================================
      async function loadFromAirtable() {
        try {
          let allRecords = [];
          let offset = null;

          // Fetch all records (handle pagination)
          do {
            let url = `https://api.airtable.com/v0/${
              CONFIG.baseId
            }/${encodeURIComponent(CONFIG.tableName)}?`;

            // Add filter if specified
            if (CONFIG.filterFormula) {
              url += `filterByFormula=${encodeURIComponent(
                CONFIG.filterFormula
              )}&`;
            }

            // Add offset for pagination
            if (offset) {
              url += `offset=${offset}`;
            }

            const response = await fetch(url, {
              headers: {
                Authorization: `Bearer ${CONFIG.token}`,
              },
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(
                `Airtable API error: ${response.status} - ${errorText}`
              );
            }

            const data = await response.json();
            allRecords = allRecords.concat(data.records);
            offset = data.offset;
          } while (offset);

          // Transform Airtable records to our format
          contentFiles = allRecords
            .map((record) => {
              const fields = record.fields;
              const contentUrl = fields[CONFIG.fields.contentUrl];

              // Skip records without a content URL
              if (!contentUrl) {
                return null;
              }

              // Determine file type from URL
              const url = contentUrl;
              const fileName = url.split("/").pop().split("?")[0];
              const ext = fileName.split(".").pop().toLowerCase();

              let type = "file";
              if (["jpg", "jpeg", "png", "gif", "webp", "svg"].includes(ext)) {
                type = "image";
              } else if (["mp4", "webm", "mov", "avi", "mkv"].includes(ext)) {
                type = "video";
              }

              const fileId = `file_${record.id}`;
              const status = (
                fields[CONFIG.fields.status] || "Pending"
              ).toLowerCase();

              // Store approval state
              approvalStates[fileId] = {
                status: status,
                airtableRecordId: record.id,
              };

              return {
                id: fileId,
                airtableRecordId: record.id,
                url: url,
                type: type,
                title: fields[CONFIG.fields.title] || fileName,
                description: fields[CONFIG.fields.description] || "",
                hashtags: fields[CONFIG.fields.hashtags] || "",
                viralScore: fields[CONFIG.fields.viralScore] || null,
                viralReason: fields[CONFIG.fields.viralReason] || "",
                socialcontentPlatforms: fields[CONFIG.fields.socialcontentPlatforms] || "",
              };
            })
            .filter((file) => file !== null)
            .sort((a, b) => {
              // Sort by viral score descending (highest first)
              // Handle null/undefined scores by treating them as -1
              const scoreA = a.viralScore !== null && a.viralScore !== undefined ? parseFloat(a.viralScore) : -1;
              const scoreB = b.viralScore !== null && b.viralScore !== undefined ? parseFloat(b.viralScore) : -1;
              return scoreB - scoreA;
            });

          // Find Work Order record if workOrderName is specified
          if (CONFIG.tableName) {
            await findWorkOrderRecord();
          }
        } catch (error) {
          throw error;
        }
      }

      // ============================================
      // FIND WORK ORDER RECORD
      // ============================================
      async function findWorkOrderRecord() {
        try {
          const url = `https://api.airtable.com/v0/${
            CONFIG.baseId
          }/${encodeURIComponent(CONFIG.workOrdersTable.tableName)}?filterByFormula=${encodeURIComponent(
            `{${CONFIG.workOrdersTable.nameField}} = '${CONFIG.tableName}'`
          )}`;

          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${CONFIG.token}`,
            },
          });

          if (!response.ok) {
            throw new Error(`Failed to find Work Order: ${response.status}`);
          }

          const data = await response.json();
          
          if (data.records && data.records.length > 0) {
            workOrderRecordId = data.records[0].id;
            
            // Check if work order is already approved
            const workOrderFields = data.records[0].fields;
            isWorkOrderApproved = workOrderFields[CONFIG.workOrdersTable.approvedCheckboxField] || false;
            
            // Set read-only mode if already approved
            if (isWorkOrderApproved) {
              isReadOnlyMode = true;
              console.log('‚úÖ Work order is already approved - entering read-only mode');
            }
          }
        } catch (error) {
          // Silently fail - Work Order update is optional
          console.error('Error finding work order:', error);
        }
      }

      // ============================================
      // RENDER content GRID
      // ============================================
      function rendercontentGrid() {
        const grid = document.getElementById("contentGrid");

        if (contentFiles.length === 0) {
          grid.innerHTML = '<div class="loading">No content found</div>';
          return;
        }

        grid.innerHTML = "";

        contentFiles.forEach((file) => {
          const card = createcontentCard(file);
          grid.appendChild(card);
        });
      }

      // ============================================
      // GET VIRAL SCORE LEVEL
      // ============================================
      function getViralScoreLevel(score) {
        if (score === null || score === undefined) return null;
        const numScore = parseFloat(score);
        if (isNaN(numScore)) return null;
        
        if (numScore >= 7) return "high";
        if (numScore >= 4) return "medium";
        return "low";
      }

      // ============================================
      // CREATE content CARD
      // ============================================
      function createcontentCard(file) {
        const card = document.createElement("div");
        card.className = "content-card";
        card.id = `card-${file.id}`;

        const status = approvalStates[file.id]?.status || "pending";
        if (status === "approved") {
          card.classList.add("approved");
        } else if (status === "denied") {
          card.classList.add("denied");
        }

        // content preview
        let contentHTML = "";
        if (file.type === "video") {
          contentHTML = `<video src="${file.url}" class="content-preview video" controls></video>`;
        } else if (file.type === "image") {
          contentHTML = `<img src="${file.url}" class="content-preview" alt="${file.title}" loading="lazy">`;
        } else {
          contentHTML = `<div class="content-preview" style="display:flex;align-items:center;justify-content:center;color:#999;">
                    <span>üìÑ File</span>
                </div>`;
        }

        // Viral score badge
        let viralScoreBadge = "";
        if (file.viralScore !== null && file.viralScore !== undefined) {
          const scoreLevel = getViralScoreLevel(file.viralScore);
          const reason = file.viralReason || "No reason provided";
          
          viralScoreBadge = `
            <div class="viral-score-badge ${scoreLevel}" data-reason="${reason.replace(/"/g, '&quot;')}" title="Hover for details">
              üî• ${file.viralScore}
            </div>
          `;
        }

        // Parse hashtags
        const hashtags = file.hashtags
          ? file.hashtags
              .split(/[,\s]+/)
              .filter((h) => h)
              .map((tag) => {
                const cleanTag = tag.startsWith("#") ? tag : `#${tag}`;
                return `<span class="hashtag">${cleanTag}</span>`;
              })
              .join("")
          : "";

        card.innerHTML = `
                ${contentHTML}
                <div class="content-info">
                    <div class="content-header">
                        ${
                          file.title
                            ? `<div class="content-title">${file.title}</div>`
                            : ""
                        }
                        ${viralScoreBadge}
                    </div>
                    ${
                      file.description
                        ? `<div class="content-description">${file.description}</div>`
                        : ""
                    }
                    ${
                      hashtags
                        ? `<div class="content-hashtags">${hashtags}</div>`
                        : ""
                    }
                    <div class="approval-section">
                        <div class="status-selector">
                            <button class="status-button ${
                              status === "approved" ? "active approved" : ""
                            }" 
                                    data-file-id="${file.id}"
                                    data-status="approved"
                                    ${isReadOnlyMode ? 'disabled style="cursor: not-allowed; opacity: 0.6;"' : ''}>
                                ‚úì Approve
                            </button>
                            <button class="status-button ${
                              status === "pending" ? "active pending" : ""
                            }" 
                                    data-file-id="${file.id}"
                                    data-status="pending"
                                    ${isReadOnlyMode ? 'disabled style="cursor: not-allowed; opacity: 0.6;"' : ''}>
                                ‚óã Pending
                            </button>
                            <button class="status-button ${
                              status === "denied" ? "active denied" : ""
                            }" 
                                    data-file-id="${file.id}"
                                    data-status="denied"
                                    ${isReadOnlyMode ? 'disabled style="cursor: not-allowed; opacity: 0.6;"' : ''}>
                                ‚úï Deny
                            </button>
                        </div>
                    </div>
                </div>
            `;

        // Add event listeners to status buttons (only if not in read-only mode)
        if (!isReadOnlyMode) {
          const statusButtons = card.querySelectorAll(".status-button");
          statusButtons.forEach((btn) => {
            btn.addEventListener("click", function () {
              const fileId = this.dataset.fileId;
              const status = this.dataset.status;
              setStatus(fileId, status);
            });
          });
        }

        return card;
      }

      // ============================================
      // SET STATUS
      // ============================================
      function setStatus(fileId, status) {
        // Prevent changes in read-only mode
        if (isReadOnlyMode) {
          return;
        }

        if (!approvalStates[fileId]) {
          approvalStates[fileId] = {};
        }

        approvalStates[fileId].status = status;

        // Update UI
        const card = document.getElementById(`card-${fileId}`);
        card.classList.remove("approved", "denied");
        if (status === "approved") {
          card.classList.add("approved");
        } else if (status === "denied") {
          card.classList.add("denied");
        }

        // Update buttons
        const buttons = card.querySelectorAll(".status-button");
        buttons.forEach((btn) => {
          btn.classList.remove("active", "approved", "pending", "denied");
          if (btn.dataset.status === status) {
            btn.classList.add("active", status);
          }
        });

        updateStats();
      }

      // ============================================
      // GET WORK ORDERS PAGE URL
      // ============================================
      function getWorkOrdersPageUrl() {
        // Try to construct work orders page URL
        const currentUrl = window.location.href;
        
        // If we came from work orders page, referrer should have it
        if (document.referrer && document.referrer.includes('work-orders')) {
          return document.referrer;
        }
        
        // Try to construct URL based on current page
        // Replace approval page with work orders page
        if (currentUrl.includes('/approval') || currentUrl.includes('content-approval')) {
          const baseUrl = currentUrl.split(/\/(approval|content-approval)/)[0];
          return `${baseUrl}/work-orders-dashboard.html?baseId=${encodeURIComponent(CONFIG.baseId)}`;
        }
        
        // Construct from base URL
        const origin = window.location.origin;
        const pathname = window.location.pathname;
        const baseUrl = origin + pathname.substring(0, pathname.lastIndexOf('/'));
        return `${baseUrl}/work-orders-dashboard.html?baseId=${encodeURIComponent(CONFIG.baseId)}`;
      }

      // ============================================
      // SYNC TO AIRTABLE
      // ============================================
      async function syncToAirtable() {
        // Prevent submissions in read-only mode
        if (isReadOnlyMode) {
          alert("‚ö†Ô∏è This work order is already approved. You cannot make changes in read-only mode.");
          return;
        }

        try {
          const updates = [];

          // Prepare updates for all content records
          for (const [fileId, state] of Object.entries(approvalStates)) {
            if (state.airtableRecordId) {
              updates.push({
                id: state.airtableRecordId,
                fields: {
                  [CONFIG.fields.status]: state.status,
                },
              });
            }
          }

          if (updates.length === 0) {
            alert("No records to update");
            return;
          }

          // Show loading state
          const submitButton = document.getElementById('submitButton');
          const originalText = submitButton.textContent;
          submitButton.disabled = true;
          submitButton.textContent = "‚è≥ Submitting...";

          // Batch updates to content table (max 10 per request)
          const batchSize = 10;
          let successCount = 0;

          for (let i = 0; i < updates.length; i += batchSize) {
            const batch = updates.slice(i, i + batchSize);

            const url = `https://api.airtable.com/v0/${
              CONFIG.baseId
            }/${encodeURIComponent(CONFIG.tableName)}`;
            
            const response = await fetch(url, {
              method: "PATCH",
              headers: {
                Authorization: `Bearer ${CONFIG.token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ records: batch }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Airtable API error: ${response.status} - ${errorText}`);
            }

            successCount += batch.length;
          }

          // Update Work Order checkbox when saving
          await updateWorkOrder();

          // Trigger n8n webhook with approved content
          await triggerN8nWorkflow();

          // Show success message
          alert(`‚úì Successfully submitted ${successCount} approvals!\n\nRedirecting to Work Orders...`);

          // Redirect to work orders page
          const workOrdersUrl = getWorkOrdersPageUrl();
          window.location.href = workOrdersUrl;

        } catch (error) {
          alert(`Error: ${error.message}`);
          // Re-enable button on error
          const submitButton = document.getElementById('submitButton');
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = "üì§ Submit Approvals";
          }
        }
      }

      // ============================================
      // TRIGGER N8N WORKFLOW
      // ============================================
      async function triggerN8nWorkflow() {
        // Skip if n8n webhook is disabled
        if (!CONFIG.n8nWebhook.enabled || !CONFIG.n8nWebhook.url) {
          return;
        }

        try {
          // Get all approved content
          const approvedContent = contentFiles.filter(file => 
            approvalStates[file.id]?.status === "approved"
          );

          if (approvedContent.length === 0) {
            return;
          }

          // Prepare payload for n8n
          const payload = {
            workOrderName: CONFIG.tableName,
            airtableId: CONFIG.baseId,
            email: CONFIG.email,
            ghlLocationId: CONFIG.ghlLocationId,
            timestamp: new Date().toISOString(),
            totalApproved: approvedContent.length,
            approvedContent: approvedContent.map(file => ({
              id: file.airtableRecordId,
              title: file.title,
              description: file.description,
              url: file.url,
              type: file.type,
              hashtags: file.hashtags,
              viralScore: file.viralScore,
              viralReason: file.viralReason,
              socialcontentPlatforms: file.socialcontentPlatforms,
            })),
          };

          // Send to n8n webhook
          const response = await fetch(CONFIG.n8nWebhook.url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`n8n webhook failed: ${response.status}`);
          }

        } catch (error) {
          // Silently fail - n8n integration is optional
          // Don't disrupt the main approval flow
        }
      }

      // ============================================
      // UPDATE WORK ORDER
      // ============================================
      async function updateWorkOrder() {
        try {
          // Use Work Order found by name
          if (!workOrderRecordId) {
            return false;
          }

          // Update the Work Order checkbox
          const url = `https://api.airtable.com/v0/${
            CONFIG.baseId
          }/${encodeURIComponent(CONFIG.workOrdersTable.tableName)}`;

          const response = await fetch(url, {
            method: "PATCH",
            headers: {
              Authorization: `Bearer ${CONFIG.token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              records: [
                {
                  id: workOrderRecordId,
                  fields: {
                    [CONFIG.workOrdersTable.approvedCheckboxField]: true,
                  },
                },
              ],
            }),
          });

          if (!response.ok) {
            throw new Error(`Failed to update Work Order: ${response.status}`);
          }

          return true;

        } catch (error) {
          // Silently fail - Work Order update is optional
          return false;
        }
      }

      // ============================================
      // BATCH ACTIONS
      // ============================================
      function approveAllcontent() {
        // Prevent changes in read-only mode
        if (isReadOnlyMode) {
          alert("‚ö†Ô∏è This work order is already approved. You cannot make changes in read-only mode.");
          return;
        }

        contentFiles.forEach((file) => {
          setStatus(file.id, "approved");
        });
      }

      // ============================================
      // UPDATE STATS
      // ============================================
      function updateStats() {
        const totalCount = contentFiles.length;
        let approvedCount = 0;
        let pendingCount = 0;
        let deniedCount = 0;

        Object.values(approvalStates).forEach((state) => {
          if (state.status === "approved") approvedCount++;
          else if (state.status === "denied") deniedCount++;
          else pendingCount++;
        });

        document.getElementById("totalCount").textContent = totalCount;
        document.getElementById("approvedCount").textContent = approvedCount;
        document.getElementById("pendingCount").textContent = pendingCount;
        document.getElementById("deniedCount").textContent = deniedCount;
      }

      // ============================================
      // START
      // ============================================
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    </script>
  </body>
</html>